if command -v nix &>/dev/null; then
    # In CI, use the CI shell to avoid LD_LIBRARY_PATH conflicts with non-Nix binaries
    if [[ -n "${CI:-}" ]]; then
        use flake .#ci
    else
        use flake
    fi
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        export SSL_CERT_FILE=${NIX_SSL_CERT_FILE:-/etc/ssl/certs/ca-bundle.crt}
    else
        export SSL_CERT_FILE=${NIX_SSL_CERT_FILE:-/nix/var/nix/profiles/default/etc/ssl/certs/ca-bundle.crt}
    fi
    export UV_PYTHON_PREFERENCE=only-system
else
  uv python install 3.10
fi

# In CI, skip uv setup - it's handled by the workflow with specific Python versions
if [[ -z "${CI:-}" ]]; then
    uv python pin 3.10
    uv sync --all-extras --all-groups
    source ./.venv/bin/activate
fi
