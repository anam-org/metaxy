{
  "runbook_name": "N:1 Aggregation Example",
  "package_name": "example_aggregation",
  "description": "Demonstrates N:1 aggregation relationships where audio recordings for multiple speakers are aggregated into speaker embeddings",
  "execution_state": {
    "events": [
      {
        "type": "graph_pushed",
        "snapshot_version": "4d7a7bc4",
        "graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "timestamp": "2026-02-04T17:45:27.902650",
        "scenario_name": "Initial pipeline run",
        "step_name": null
      },
      {
        "type": "command_executed",
        "command": "python pipeline.py",
        "returncode": 0,
        "stdout": "Found 4 new audio recordings\nFound 2 speakers that need embedding computation\n  Computing embedding for speaker s1 from 2 audio recordings\n  Computing embedding for speaker s2 from 2 audio recordings\nWriting embeddings for 2 speakers\n",
        "stderr": "",
        "timestamp": "2026-02-04T17:45:28.521500",
        "scenario_name": "Initial pipeline run",
        "step_name": "run_pipeline"
      },
      {
        "type": "command_executed",
        "command": "python pipeline.py",
        "returncode": 0,
        "stdout": "No new or changed audio recordings\nFound 0 speakers that need embedding computation\n",
        "stderr": "",
        "timestamp": "2026-02-04T17:45:29.144652",
        "scenario_name": "Idempotent rerun",
        "step_name": null
      },
      {
        "type": "graph_pushed",
        "snapshot_version": "4d7a7bc4",
        "graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "timestamp": "2026-02-04T17:45:29.835908",
        "scenario_name": "Update one audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "patch_applied",
        "patch_path": "patches/01_update_audio_provenance.patch",
        "before_snapshot": "4d7a7bc4",
        "after_snapshot": "4d7a7bc4",
        "before_graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "after_graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "timestamp": "2026-02-04T17:45:29.843899",
        "scenario_name": "Update one audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "command_executed",
        "command": "python pipeline.py",
        "returncode": 0,
        "stdout": "Found 1 changed audio recordings\nFound 1 speakers that need embedding computation\n  Computing embedding for speaker s1 from 2 audio recordings\nWriting embeddings for 1 speakers\n",
        "stderr": "",
        "timestamp": "2026-02-04T17:45:30.482783",
        "scenario_name": "Update one audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "graph_pushed",
        "snapshot_version": "4d7a7bc4",
        "graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "timestamp": "2026-02-04T17:45:31.198671",
        "scenario_name": "Add new audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "patch_applied",
        "patch_path": "patches/02_add_audio.patch",
        "before_snapshot": "4d7a7bc4",
        "after_snapshot": "4d7a7bc4",
        "before_graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "after_graph": {
          "audio": {
            "metaxy_feature_version": "3dac67c8",
            "fields": {
              "default": "80200592"
            },
            "feature_spec": {
              "key": "audio",
              "id_columns": [
                "audio_id"
              ],
              "deps": [],
              "fields": [
                {
                  "key": "default",
                  "code_version": "__metaxy_initial__",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Audio recordings of different speakers."
            }
          },
          "speaker/embedding": {
            "metaxy_feature_version": "a485fa5b",
            "fields": {
              "embedding": "27a15391"
            },
            "feature_spec": {
              "key": "speaker/embedding",
              "id_columns": [
                "speaker_id"
              ],
              "deps": [
                {
                  "feature": "audio",
                  "columns": null,
                  "rename": null,
                  "fields_mapping": {
                    "mapping": {
                      "type": "default",
                      "match_suffix": false,
                      "exclude_fields": []
                    }
                  },
                  "sql_filters": null,
                  "lineage": {
                    "relationship": {
                      "type": "N:1",
                      "on": [
                        "speaker_id"
                      ]
                    }
                  },
                  "optional": false
                }
              ],
              "fields": [
                {
                  "key": "embedding",
                  "code_version": "1",
                  "deps": []
                }
              ],
              "metadata": {},
              "description": "Speaker embedding aggregated from all their audio recordings.\n\nThis demonstrates N:1 aggregation lineage where multiple audio recordings\nfrom the same speaker are aggregated into a single speaker embedding."
            }
          }
        },
        "timestamp": "2026-02-04T17:45:31.211713",
        "scenario_name": "Add new audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "command_executed",
        "command": "python pipeline.py",
        "returncode": 0,
        "stdout": "Found 1 new audio recordings\nFound 1 speakers that need embedding computation\n  Computing embedding for speaker s1 from 3 audio recordings\nWriting embeddings for 1 speakers\n",
        "stderr": "",
        "timestamp": "2026-02-04T17:45:31.841737",
        "scenario_name": "Add new audio - only affected speaker recomputed",
        "step_name": null
      },
      {
        "type": "command_executed",
        "command": "python pipeline.py",
        "returncode": 0,
        "stdout": "No new or changed audio recordings\nFound 0 speakers that need embedding computation\n",
        "stderr": "",
        "timestamp": "2026-02-04T17:45:32.445840",
        "scenario_name": "Final idempotent check",
        "step_name": null
      }
    ]
  }
}
